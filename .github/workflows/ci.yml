name: HELIX CI

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['main']

concurrency:
  group: helix-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Deno
        id: deno-setup
        uses: denoland/setup-deno@v1
        with:
          deno-version: "v2.x"

      - name: Cache Deno dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/deno
          key: deno-${{ runner.os }}-${{ steps.deno-setup.outputs.deno-version }}-${{ hashFiles('**/deno.lock', 'deno.json', 'deno.jsonc') }}
          restore-keys: |
            deno-${{ runner.os }}-

      # Validate only (no install)
      - name: Format check (server code only)
        run: deno fmt --check supabase

      - name: Lint (server code only)
        run: deno lint --rules-exclude=no-import-prefix,no-unused-vars,require-await supabase

  test:
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 15
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Deno
        id: deno-setup
        uses: denoland/setup-deno@v1
        with:
          deno-version: "v2.x"

      - name: Cache Deno dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/deno
          key: deno-${{ runner.os }}-${{ steps.deno-setup.outputs.deno-version }}-${{ hashFiles('**/deno.lock', 'deno.json', 'deno.jsonc') }}
          restore-keys: |
            deno-${{ runner.os }}-

      - name: Install Deno deps (node types / npm) with timeout & fallback
        shell: bash
        run: |
          try_install () {
            local registry="$1"
            local attempt="$2"
            local secs="$3"
            echo ">>> install attempt ${attempt} using ${registry} (timeout ${secs}s)"
            NPM_CONFIG_REGISTRY="${registry}" timeout "${secs}"s deno install
          }
          # Two attempts on npmjs, then two on npmmirror, with backoff
          try_install https://registry.npmjs.org/      1 180 || \
          (sleep 5  && try_install https://registry.npmjs.org/      2 240) || \
          (sleep 10 && try_install https://registry.npmmirror.com/  3 240) || \
          (sleep 10 && try_install https://registry.npmmirror.com/  4 300) || \
          (echo "install failed after 4 attempts" && exit 1)

      - name: Run Deno tests
        run: |
          deno test -A \
            supabase/functions/generate_weekly_plan/generate_weekly_plan.test.ts \
            supabase/functions/jobs/jobs.test.ts \
            supabase/functions/utilities/utilities.test.ts \
            supabase/functions/wearables-import-mock/wearables-import-mock.test.ts
