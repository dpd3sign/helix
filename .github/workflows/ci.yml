name: HELIX CI

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['main']
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      DENO_NO_NPM: "1"
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Deno
        id: deno-setup
        uses: denoland/setup-deno@v1
        with:
          deno-version: "v2.x"

      - name: Cache Deno dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/deno
          key: deno-${{ runner.os }}-${{ steps.deno-setup.outputs.deno-version }}-${{ hashFiles('**/deno.lock', 'deno.json', 'deno.jsonc') }}
          restore-keys: |
            deno-${{ runner.os }}-

      # Validate only (no install)
      - name: Format check (server code only)
        run: deno fmt --check supabase

      - name: Lint (server code only)
        run: deno lint --rules-exclude=no-import-prefix,no-unused-vars,require-await,no-explicit-any supabase

  test:
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 15
    env:
      DENO_NO_NPM: "1"
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}   # <-- add this line
      PGOPTIONS: "-c listen_addresses='*'"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Deno
        id: deno-setup
        uses: denoland/setup-deno@v1
        with:
          deno-version: "v2.x"

      - name: Cache Deno dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/deno
          key: deno-${{ runner.os }}-${{ steps.deno-setup.outputs.deno-version }}-${{ hashFiles('**/deno.lock', 'deno.json', 'deno.jsonc') }}
          restore-keys: |
            deno-${{ runner.os }}-       
    
      # --- Setup Supabase CLI the reliable way ---
      - name: Setup Supabase CLI
        if: ${{ env.SUPABASE_DB_URL != '' }}
        uses: supabase/setup-cli@v1
        with:
          version: latest

     # --- Install psql client (used to NOTIFY PostgREST to reload schema) ---
      - name: Install psql client
        if: ${{ env.SUPABASE_DB_URL != '' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
          psql --version
      
      # --- Apply migrations to remote and reload PostgREST schema cache ---
      - name: Apply migrations to remote (if DB URL provided)
        if: ${{ env.SUPABASE_DB_URL != '' }}
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          set -e

          # Show CLI version (not critical if migrations fall back to psql)
          supabase --version || true

          # Try CLI first (fast path). If it can't connect (IPv6 issue), fall back to psql.
          if supabase migration up --db-url "$SUPABASE_DB_URL"; then
            echo "✅ Supabase CLI migrations applied"
          else
            echo "⚠️ CLI failed to connect; falling back to psql-based migration apply"

            sudo apt-get update
            sudo apt-get install -y postgresql-client dnsutils

            # Extract host from URI and resolve an IPv4 address
            DB_HOST="$(echo "$SUPABASE_DB_URL" | sed -E 's#^postgresql://[^@]+@([^/:]+).*#\1#')"
            DB_HOST_IPV4="$(getent ahostsv4 "$DB_HOST" | awk 'NR==1{print $1}')"

            if [ -z "$DB_HOST_IPV4" ]; then
             echo "❌ Could not resolve IPv4 for $DB_HOST"
             exit 1
           fi

           echo "Using IPv4 $DB_HOST_IPV4 for $DB_HOST"

           # Build an IPv4-only URI by replacing the host
           SUPABASE_DB_URL_IPV4="$(echo "$SUPABASE_DB_URL" | sed -E "s#$DB_HOST#$DB_HOST_IPV4#")"

           # Apply every .sql file in your migrations, in order
           shopt -s nullglob
           for f in $(ls -1 supabase/migrations/*/*.sql | sort); do
             echo "Applying $f"
             psql "$SUPABASE_DB_URL_IPV4" -v ON_ERROR_STOP=1 -f "$f"
           done
           echo "✅ psql-based migration apply complete"
         fi

         # Reload PostgREST schema cache so new tables/functions are visible immediately
         psql "$SUPABASE_DB_URL" -c "NOTIFY pgrst, 'reload';" || true
 
      - name: Pre-warm test deps (no-run, CI config, no npm, no typecheck)
        shell: bash
        run: |
          set -euo pipefail
          prewarm() {
            local attempt="$1"
            local secs="$2"
            echo ">>> prewarm attempt ${attempt} (timeout ${secs}s)"
            timeout "${secs}"s deno test --config=deno.ci.json --no-npm --no-check --no-run \
              supabase/functions/generate_weekly_plan/generate_weekly_plan.test.ts \
              supabase/functions/jobs/jobs.test.ts \
              supabase/functions/utilities/utilities.test.ts \
              supabase/functions/wearables-import-mock/wearables-import-mock.test.ts
          }
          prewarm 1 180 || (sleep 5  && prewarm 2 240) || (sleep 10 && prewarm 3 300) || (echo "prewarm failed after 3 attempts" && exit 1)

      - name: Run Deno tests (CI config, no npm, no typecheck)
        run: |
          deno test --config=deno.ci.json --no-npm --no-check -A \
            supabase/functions/generate_weekly_plan/generate_weekly_plan.test.ts \
            supabase/functions/jobs/jobs.test.ts \
            supabase/functions/utilities/utilities.test.ts \
            supabase/functions/wearables-import-mock/wearables-import-mock.test.ts
